# 基础概念和脚本结构

## 📋 GainLab Script 概述

**GainLab Script** 是在GainLab图表中执行的指标脚本语言，基于 **JavaScript**，支持变量、函数、表达式与回调等现代编程特性。

### 🎯 设计理念
- 💡 **简单易学** - 基于JavaScript，学习成本低
- 🔧 **功能强大** - 支持64个官方计算函数
- 🎨 **样式丰富** - 完整的绘图和样式系统
- ⚡ **实时计算** - 随K线更新实时计算

## 🏗️ 脚本结构组成

脚本由 **6个核心部分** 按顺序组成：

```javascript
// 1. 元数据定义
//@name=MA
//@title=MovingAverage 移动平均线
//@desc=移动平均线指标
//@position=main
//@version=1

// 2. 输入参数定义（I方法）
period = I.int(20, title='周期', min=1, max=500)
source = I.select('close', title='数据源', options=SOURCE)

// 3. 样式定义（S方法）
maStyle = S.line('#F00', 1, 'solid', title='MA样式')

// 4. 计算逻辑（F方法）
ma = F.ma(dataList, period, source)

// 5. 图形绘制（D方法）
D.line(ma, maStyle)

// 6. 数据输出（O方法）
setPrecision('price')
O.tools('MA' + period, ma, maStyle)
```

### 📊 结构说明

| 部分 | 作用 | 是否必填 | 示例 |
|------|------|---------|------|
| **元数据** | 定义脚本基本信息 | ✅ 必填 | `@name`、`@position` |
| **输入参数** | 用户可调节的参数 | ❌ 可选 | `I.int()`、`I.select()` |
| **样式定义** | 图形显示样式 | ❌ 可选 | `S.line()`、`S.bar()` |
| **计算逻辑** | 数据计算处理 | ✅ 必填 | `F.ma()`、`F.rsi()` |
| **图形绘制** | 在图表上绘图 | ✅ 必填 | `D.line()`、`D.bar()` |
| **数据输出** | 输出结果数据 | ❌ 可选 | `O.tools()`、精度设置 |

## 🏷️ 元数据系统

### 必填元数据

#### @name （脚本名称）
```javascript
//@name=MA        // ✅ 简洁名称，显示在工具栏
//@name=MACD      // ✅ 用于标识脚本
```

#### @position （显示位置）
```javascript
//@position=main  // ✅ 主图显示（与K线同一图表）
//@position=vice  // ✅ 副图显示（独立图表区域）
```

#### @version （引擎版本）
```javascript
//@version=1      // ✅ 当前只支持版本1
```

### 可选元数据

#### @title （完整标题）
```javascript
//@title=MovingAverage 移动平均线    // 显示在设置面板
```

#### @desc （详细描述）
```javascript
//@desc=## MovingAverage 移动平均线
//作为衡量主力成本重要的参照指标，用以观察价格变动趋势
//#### 应用法则：
//- 价格突破平均线时产生交易信号
//- 支持**粗体**和- 列表等markdown格式
```

**描述格式规则**：
- 第一行：`//@desc=内容`
- 后续行：`//内容`
- 支持markdown：`#标题`、`**粗体**`、`- 列表`、`1. 有序列表`


## 📊 内置数据系统

### dataList（K线数据）
**全局变量**，包含当前图表的所有K线数据：

```javascript
// dataList 结构示例
dataList[0] = {
    timestamp: 1640995200000,    // 时间戳（毫秒）
    open: 46500.00,              // 开盘价
    high: 47200.00,              // 最高价  
    low: 46300.00,               // 最低价
    close: 46800.00,             // 收盘价
    volume: 12345.67,            // 成交量
    turnover: 578901234.56       // 成交额
}

// 使用示例
O.print('K线总数: ' + dataList.length);
O.print('最新收盘价: ' + dataList[dataList.length-1].close);
```

### visibleList（可见K线数据）
当前窗口内可见的K线数据，结构与dataList相同：

```javascript
// 获取可见区域的数据
O.print('可见K线数: ' + visibleList.length);
```

### 其他内置数据
```javascript
chartSymbol    // 交易对名称，如 'BTCUSDT'
chartPeriod    // 图表周期，如 '1m', '1h', '1d'
```

## 🎛️ 数据类型系统

### 基础数据类型

#### 数值类型
```javascript
let price = 46500.00;         // 浮点数
let volume = 12345;           // 整数
let ratio = 0.618;            // 小数
```

#### 字符串类型  
```javascript
let symbol = 'BTCUSDT';       // 字符串
let period = '1h';            // 时间周期
let message = `当前价格: ${price}`;  // 模板字符串
```

#### 布尔类型
```javascript
let isUptrend = true;         // 布尔值
let showSignal = false;       // 开关状态
```

#### 数组类型
```javascript
let prices = [100, 101, 99, 102];           // 数值数组
let signals = [true, false, true, false];   // 布尔数组
let mixed = [100, 'up', true, null];        // 混合数组
```

#### 对象类型
```javascript
let kline = {
    open: 100,
    high: 105, 
    low: 99,
    close: 103
};

// K线对象还支持计算属性
let hl2 = kline.hl2;          // (high + low) / 2
let hlc3 = kline.hlc3;        // (high + low + close) / 3
let ohlc4 = kline.ohlc4;      // (open + high + low + close) / 4
```

### 计算属性（F.attr支持）

#### K线计算属性
```javascript
// 基础属性
F.attr(dataList, 'open')      // 开盘价数组
F.attr(dataList, 'high')      // 最高价数组
F.attr(dataList, 'low')       // 最低价数组
F.attr(dataList, 'close')     // 收盘价数组
F.attr(dataList, 'volume')    // 成交量数组

// 组合计算属性
F.attr(dataList, 'hl2')       // (最高价+最低价) / 2
F.attr(dataList, 'oc2')       // (开盘价+收盘价) / 2
F.attr(dataList, 'hlc3')      // (最高价+最低价+收盘价) / 3
F.attr(dataList, 'ohl3')      // (最高价+最低价+开盘价) / 3
F.attr(dataList, 'ohlc4')     // (最高价+最低价+开盘价+收盘价) / 4
F.attr(dataList, 'percentage') // 涨跌幅百分比
```

## 🌍 SOURCE 常量

**全局常量**，用于数据源选择：

```javascript
SOURCE = [
    'close',     // 收盘价
    'open',      // 开盘价
    'high',      // 最高价
    'low',       // 最低价
    'volume',    // 成交量
    'hl2',       // (最高价+最低价) / 2
    'oc2',       // (开盘价+收盘价) / 2
    'hlc3',      // (最高价+最低价+收盘价) / 3
    'ohl3',      // (最高价+最低价+开盘价) / 3
    'ohlc4'      // (最高价+最低价+开盘价+收盘价) / 4
]

// 使用示例
source = I.select('close', title='数据源', options=SOURCE)
```

## 🎮 方法简写系统

所有方法都支持**简写形式**，提高编码效率：

```javascript
// 完整写法 vs 简写形式
input.int()   === I.int()      // 输入参数
style.line()  === S.line()     // 样式定义
draw.line()   === D.line()     // 图形绘制
output.tools() === O.tools()   // 数据输出
formula.ma()  === F.ma()       // 计算函数
util.sum()    === U.sum()      // 工具函数
```

## ⚙️ 精度与显示设置

### setPrecision() 精度设置
```javascript
// 三种精度模式
setPrecision('price')    // 使用价格精度（推荐用于价格类指标）
setPrecision('volume')   // 使用成交量精度（推荐用于成交量类指标）
setPrecision(4)         // 自定义小数位数

// 使用示例
ma = F.ma(dataList, 20, 'close')
D.line(ma, maStyle)
setPrecision('price')    // 设置为价格精度
```

### 副图专用设置
```javascript
// 只在副图(@position=vice)中有效
setMax(100)    // 设置Y轴最大值
setMin(0)      // 设置Y轴最小值

// 使用示例 - RSI指标
//@position=vice
rsi = F.rsi(dataList, 14)
D.line(rsi, rsiStyle)
setMax(100)
setMin(0)
setPrecision(2)
```

## 🔄 JavaScript 语法支持

### ✅ 支持的语法特性

#### 变量定义
```javascript
let value = 100;                // let 声明
const PERIOD = 20;              // const 声明（推荐）
var oldStyle = 'legacy';        // var 声明（不推荐）
```

#### 控制结构
```javascript
// 条件语句
if (price > ma) {
    signal = 'buy';
} else if (price < ma) {
    signal = 'sell';
} else {
    signal = 'hold';
}

// 循环结构
for (let i = 0; i < dataList.length; i++) {
    // 处理每根K线
}

dataList.forEach((kline, index) => {
    // 更现代的遍历方式
});

while (condition) {
    // 循环处理
}
```

#### 函数定义
```javascript
// 普通函数
function calculateMA(data, period) {
    return F.ma(data, period, 'close');
}

// 箭头函数
const getSignal = (current, prev) => {
    return current > prev ? 'up' : 'down';
};
```

#### 数组操作
```javascript
// 数组方法
let prices = F.attr(dataList, 'close');
let filtered = prices.filter(p => p > 100);
let doubled = prices.map(p => p * 2);
let sum = prices.reduce((a, b) => a + b, 0);
```

#### 对象操作
```javascript
// 对象字面量
let config = {
    period: 20,
    source: 'close',
    style: 'solid'
};

// 解构赋值
let {period, source} = config;

// 展开运算符
let newConfig = {...config, period: 50};
```

#### 模板字符串
```javascript
let message = `MA${period} 当前值: ${ma[ma.length-1]}`;
O.print(message);
```

### ❌ 不支持的特性
- **异步操作**: async/await, Promise
- **定时器**: setTimeout, setInterval
- **网络请求**: fetch, XMLHttpRequest
- **浏览器API**: DOM操作, File API
- **Node.js API**: fs, path等模块

## 🔧 内置工具函数

### Math 数学对象
```javascript
Math.max(a, b)          // 最大值
Math.min(a, b)          // 最小值  
Math.abs(x)             // 绝对值
Math.round(x)           // 四舍五入
Math.floor(x)           // 向下取整
Math.ceil(x)            // 向上取整
Math.pow(x, y)          // 幂运算
Math.sqrt(x)            // 平方根
Math.PI                 // 圆周率
```

### 常用JavaScript方法
```javascript
// 数组方法
array.length            // 数组长度
array.push(item)        // 添加元素
array.slice(start, end) // 切片
array.join(separator)   // 连接为字符串

// 字符串方法
string.length           // 字符串长度
string.indexOf(substr)  // 查找子字符串
string.substring(start, end) // 截取字符串
string.toUpperCase()    // 转大写
string.toLowerCase()    // 转小写
```

## 🎯 最佳实践示例

### 完整的BBI指标
```javascript
//@name=BBI
//@title=BBI 多空指数
//@desc=BBI（Bull and Bear Index）多空指数
//是一种将不同周期移动平均线加权平均之后的综合指标，属于均线型指标，一般选用3、6、12、24等4个参数。
//它是针对普通移动平均线MA指标的一种改进，既有短期移动平均线的灵敏，又有明显的中期趋势特征。
//@position=main
//@version=1

// 输入参数定义
N1 = I.int(3, title="N1", tip="第一个周期参数")
N2 = I.int(6, title="N2", tip="第二个周期参数") 
N3 = I.int(12, title="N3", tip="第三个周期参数")
N4 = I.int(24, title="N4", tip="第四个周期参数")

// 样式定义
bbiStyle = S.line('#9933FF', 1, 'solid', title="BBI样式")

// 计算BBI
// BBI = (MA(CLOSE, N1) + MA(CLOSE, N2) + MA(CLOSE, N3) + MA(CLOSE, N4)) / 4

// 计算四个周期的移动平均线
ma1 = F.ma(dataList, N1, 'close')
ma2 = F.ma(dataList, N2, 'close')
ma3 = F.ma(dataList, N3, 'close')
ma4 = F.ma(dataList, N4, 'close')

// 计算BBI = (MA1 + MA2 + MA3 + MA4) / 4
bbi = ma1.map((value, index) => {
  if (value !== null && ma2[index] !== null && ma3[index] !== null && ma4[index] !== null) {
    return (value + ma2[index] + ma3[index] + ma4[index]) / 4
  }
  return null
})

// 绘制BBI线
D.line(bbi, bbiStyle)

// 添加工具提示
O.tools('BBI', bbi, bbiStyle) 
// 设置精度
setPrecision('price')
```

## 🔗 相关链接

- **下一步学习**: [I方法详解](03-输入参数方法(I方法).md) - 学习参数定义
- **样式美化**: [S方法详解](04-样式设置方法(S方法).md) - 学习样式设置  
- **核心计算**: [F方法详解](05-计算函数方法(F方法).md) - 学习计算函数
- **图形绘制**: [D方法详解](06-绘图输出方法(D方法).md) - 学习绘图方法
- **完整案例**: [脚本案例库](09-完整脚本案例库.md) - 查看实际案例

---
**提示**: 掌握基础概念后，建议按顺序学习各个方法的详细用法，循序渐进掌握GainLab Script编程技能。