# 重要规则汇总

> ⚠️ **编程前必读** - 本文档包含所有关键约束和注意事项，违反将导致脚本错误！

## 📋 核心规则清单

### ✅ 必须遵守的规则
- [ ] 元数据必填项正确设置
- [ ] I/S方法使用常量，禁止变量
- [ ] F/U方法严格按文档使用
- [ ] 数组操作避免直接表达式
- [ ] JavaScript语法支持范围内编程

## 🏷️ 元数据规则

### 必填元数据
```javascript
//@name=脚本名称     // ✅ 必填，显示在工具栏
//@position=main     // ✅ 必填，main(主图) 或 vice(副图)
//@version=1         // ✅ 必填，脚本引擎版本
```

### 可选元数据
```javascript
//@title=完整标题          // 显示在设置面板
//@desc=详细描述           // 支持简单markdown
//多行描述继续用//开头
//@vip=1                  // VIP标识（可选）
```

### ❌ 常见错误
```javascript
// ❌ 错误：缺少必填元数据
//@name=MA    // 只有name，缺少position和version

// ❌ 错误：元数据格式错误  
// @name = MA    // 多余空格
//@Name=MA      // 大小写错误

// ✅ 正确：完整的元数据
//@name=MA
//@position=main  
//@version=1
```

## 🔧 I方法（输入参数）限制

### 🚫 严格禁止事项

#### 1. 禁止使用变量
```javascript
// ❌ 错误：使用变量
let defaultPeriod = 14;
const period = I.int(defaultPeriod, '周期');    // 报错！

// ❌ 错误：使用计算结果
const period = I.int(10+4, '周期');              // 报错！

// ✅ 正确：使用常量
const period = I.int(14, '周期');                // 正确！
```

#### 2. 禁止在循环/条件中使用
```javascript
// ❌ 错误：在条件语句中使用
if (someCondition) {
    period = I.int(14, '周期');    // 报错！
}

// ❌ 错误：在循环中使用
for(let i = 0; i < 5; i++) {
    const p = I.int(i, '周期' + i);    // 报错！
}

// ✅ 正确：在脚本开头使用
period = I.int(14, '周期');    // 正确！
```

#### 3. 必须在脚本开头定义
```javascript
// ✅ 正确的顺序
//@name=MA
//@position=main
//@version=1

// I方法必须在这里定义
period = I.int(14, '周期');
source = I.select('close', '数据源', options=SOURCE);

// 然后才是S方法
maStyle = S.line('#F00', 1, 'solid');

// 最后是计算和绘图
ma = F.ma(dataList, period, source);
D.line(ma, maStyle);
```

### ✅ I方法参数规则
- **default**: 必填，必须是常量
- **title**: 可选，字符串
- **min/max**: 可选，数值类型参数适用
- **tip**: 可选，提示说明
- **options**: 可选，select方法适用

## 🎨 S方法（样式设置）限制

### 🚫 严格禁止事项

#### 1. 禁止使用变量作为初始值
```javascript
// ❌ 错误：使用变量
let defaultColor = '#FF0000';
const lineStyle = S.line(defaultColor, 1);    // 报错！

// ✅ 正确：使用常量
const lineStyle = S.line('#FF0000', 1);       // 正确！
```

#### 2. 动态样式的正确使用
```javascript
// ✅ 正确：动态样式在回调函数中使用
upStyle = S.line('#00FF00', 2);
downStyle = S.line('#FF0000', 2);

D.line(data, ({value, prev}) => {
    return value > prev ? upStyle : downStyle;    // 正确！
});
```

### ✅ S方法最佳实践
```javascript
// ✅ 推荐：在脚本开头定义所有样式
maStyle1 = S.line('#F00', 1, 'solid', title="MA1样式");
maStyle2 = S.line('#0FF', 2, 'dashed', title="MA2样式");
barStyle = S.bar('#00FF00', 'fill', title="柱状图样式");
```

## 🧮 F方法（计算函数）规则

### 🚫 严格限制

#### 1. 参数顺序不能错
```javascript
// ❌ 错误：参数顺序错误
ma = F.ma(20, dataList, 'close');    // 错误！

// ✅ 正确：严格按文档顺序
ma = F.ma(dataList, 20, 'close');    // 正确！
```

#### 2. 数据类型必须匹配
```javascript
// ❌ 错误：传入错误的数据类型
rsi = F.rsi([1,2,3], 14);           // 错误！需要K线数据

// ✅ 正确：传入正确的数据类型
rsi = F.rsi(dataList, 14);          // 正确！
```

#### 3. 返回值处理
```javascript
// ⚠️ 注意：F方法可能返回null值
ma = F.ma(dataList, 20, 'close');

// ✅ 正确：检查有效性
dataList.forEach((item, index) => {
    if (ma[index] !== null) {
        // 处理有效数据
    }
});
```

## 📊 数组操作限制

### 🚫 严格禁止的数组操作

#### 1. 不支持直接表达式作为数组元素
```javascript
// ❌ 错误：数组中使用表达式
const data = [dataList[0].close + dataList[0].open];    // 可能报错

// ✅ 正确：先计算再赋值
const firstSum = dataList[0].close + dataList[0].open;
const data = [firstSum];
```

#### 2. 复杂数组操作需要分步进行
```javascript
// ❌ 错误：过于复杂的一行操作
const result = dataList.map(item => item.close * 2).filter(val => val > 100);

// ✅ 正确：分步操作
const doubled = dataList.map(item => item.close * 2);
const result = doubled.filter(val => val > 100);
```

## 🖥️ JavaScript支持范围

### ✅ 支持的特性
- ✅ 变量定义（let, const, var）
- ✅ 基本数据类型（number, string, boolean）
- ✅ 数组和对象操作
- ✅ if/for/forEach/while控制结构
- ✅ 函数定义和调用
- ✅ 箭头函数
- ✅ 解构赋值
- ✅ 模板字符串
- ✅ 三元运算符
- ✅ Math对象方法

### ❌ 不支持或受限的特性
- ❌ async/await（不支持异步）
- ❌ Promise（不支持异步）
- ❌ setTimeout/setInterval（不支持定时器）
- ❌ DOM操作（不支持浏览器API）
- ❌ 网络请求（不支持fetch/XMLHttpRequest）
- ❌ 文件操作（不支持File API）

## 🎯 绘图方法（D方法）注意事项

### 📊 数据有效性
```javascript
// ⚠️ 注意：处理null/undefined值
const ma = F.ma(dataList, 20, 'close');

// 绘图前检查数据有效性
D.line(ma, maStyle);    // 自动处理null值，产生断点

// 连续绘图设置
lineStyle.continuous = true;    // 在null值之间绘制连线
```

### 🎨 样式回调函数
```javascript
// ✅ 正确：样式回调函数格式
D.line(data, ({value, index, prev}) => {
    return value > prev ? upStyle : downStyle;    // 必须返回样式对象
});

// ❌ 错误：没有返回值
D.line(data, ({value}) => {
    if (value > 0) {
        console.log("positive");    // 错误！没有返回样式
    }
});
```

## 🔢 数值精度和范围

### 精度设置规则
```javascript
// ✅ 正确：精度设置
setPrecision('price');     // 使用价格精度
setPrecision('volume');    // 使用成交量精度  
setPrecision(4);          // 使用固定小数位数

// 副图专用设置
setMax(100);    // 设置Y轴最大值
setMin(0);      // 设置Y轴最小值
```

### 数值有效性检查
```javascript
// ✅ 使用工具函数检查
if (U.isValidNumber(value)) {
    // 处理有效数值
}

if (U.isValid(data)) {
    // 处理有效数据（非null/undefined/空字符串/空对象）
}
```

## 🐛 常见错误和避坑指南

### 错误类型1：元数据缺失
```javascript
// ❌ 错误原因：缺少@position
//@name=MA
//@version=1
// 脚本不显示！

// ✅ 解决方案：补充必填元数据
//@name=MA
//@position=main    // 必填！
//@version=1
```

### 错误类型2：I方法使用变量
```javascript
// ❌ 错误原因：在I方法中使用变量
let defaultPeriod = 20;
period = I.int(defaultPeriod, '周期');    // 报错！

// ✅ 解决方案：使用常量
period = I.int(20, '周期');    // 正确！
```

### 错误类型3：F方法参数错误
```javascript
// ❌ 错误原因：参数顺序错误
ma = F.ma(20, dataList, 'close');

// ✅ 解决方案：按文档顺序
ma = F.ma(dataList, 20, 'close');
```

### 错误类型4：数据处理不当
```javascript
// ❌ 错误原因：没有处理null值
D.line(F.ma(dataList, 20), style);    // 可能有null值

// ✅ 解决方案：F方法自动处理null，D方法自动跳过
// 通常不需要手动处理，除非有特殊需求
```

## 🔧 调试技巧

### 使用O.print()调试
```javascript
// ✅ 调试输出
ma = F.ma(dataList, 20, 'close');
O.print('MA数组长度: ' + ma.length);
O.print('第一个MA值: ' + ma[0]);

// 检查数据有效性
dataList.forEach((item, index) => {
    if (ma[index] === null) {
        O.print(`索引 ${index} 的MA值为null`);
    }
});
```

### 分段验证
```javascript
// ✅ 分段验证代码
// 1. 先验证参数
O.print('周期: ' + period);
O.print('数据源: ' + source);

// 2. 验证计算
ma = F.ma(dataList, period, source);
O.print('MA计算完成，有效数据: ' + ma.filter(v => v !== null).length);

// 3. 验证绘图
D.line(ma, maStyle);
O.print('绘图完成');
```

## 📋 上线前检查清单

- [ ] ✅ 所有必填元数据已设置
- [ ] ✅ I方法只使用常量，无变量
- [ ] ✅ S方法在脚本开头定义
- [ ] ✅ F方法参数顺序正确
- [ ] ✅ D方法样式参数有效
- [ ] ✅ 使用setPrecision()设置精度
- [ ] ✅ 没有使用不支持的JavaScript特性
- [ ] ✅ 数组操作符合规范
- [ ] ✅ 没有语法错误
- [ ] ✅ 测试了边界情况

## 🆘 紧急求助

当遇到问题时：
1. 🔍 **检查语法** - 使用O.print()输出调试信息
2. 📖 **查阅文档** - 确认方法使用是否正确
3. 🔧 **简化代码** - 逐步注释代码定位问题
4. 📝 **对比案例** - 参考[脚本案例库](09-完整脚本案例库.md)中的示例

---
**重要提醒**: 本文档涵盖了99%的常见错误原因，编程前务必详细阅读！