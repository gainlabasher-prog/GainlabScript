# O方法 - 数据输出

## 📋 O方法概述

**O方法（Output Method）**用于将脚本计算结果输出到用户界面，包括工具面板显示、调试信息输出等，提供5个专业输出方法，是用户与指标交互的重要桥梁。

### 🎯 核心特点
- 📊 **工具面板集成** - 直接输出到GainLab工具面板供用户查看
- 🔍 **调试支持** - 提供调试信息输出便于开发调试
- 📝 **格式控制** - 支持精度控制和数据格式化
- 🎨 **样式继承** - 输出内容继承绘图样式的颜色和格式

### ⚠️ 核心约束
- **✅ 输出顺序** - 按调用顺序在工具面板中显示
- **✅ 样式匹配** - O.tools()的样式应与D方法绘图样式一致
- **✅ 数据有效性** - 自动处理null值，显示为空或默认值
- **✅ 性能考虑** - 避免过量的调试输出影响性能

## 🗂️ O方法完整列表

| 方法 | 功能 | 输出位置 | 使用频率 |
|------|------|---------|---------|
| [O.tools()](#O.tools) | 工具面板输出 | 工具面板 | 🔥 极高 |
| [O.print()](#O.print) | 调试信息输出 | 控制台 | 📊 高 |
| [O.log()](#O.log) | 日志记录输出 | 日志文件 | 📝 中等 |
| [O.notify()](#O.notify) | 通知消息输出 | 通知栏 | 📝 中等 |
| [O.export()](#O.export) | 数据导出输出 | 导出文件 | 📝 低 |

## 🔧 核心输出方法

### O.tools() - 工具面板输出

将指标数据输出到GainLab工具面板，是最重要的输出方法。

#### 语法格式
```javascript
O.tools(name, data, style?, options?)
```

#### 参数详解
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `name` | string | ✅ | 显示名称 |
| `data` | array | ✅ | 输出数据 |
| `style` | object | ❌ | 样式对象（继承颜色等） |
| `options` | object | ❌ | 输出选项 |

#### 基础示例
```javascript
//@name=双均线输出示例
//@position=main
//@version=1

// 参数定义
fastPeriod = I.int(5, '快线周期')
slowPeriod = I.int(20, '慢线周期')

// 样式定义
fastStyle = S.line('#FF0000', 2, 'solid', title='快线')
slowStyle = S.line('#0000FF', 2, 'solid', title='慢线')

// 计算和绘制
fastMA = F.ma(dataList, fastPeriod, 'close')
slowMA = F.ma(dataList, slowPeriod, 'close')

D.line(fastMA, fastStyle)
D.line(slowMA, slowStyle)

// 设置精度
setPrecision('price')

// 工具面板输出
O.tools('快线MA' + fastPeriod, fastMA, fastStyle)
O.tools('慢线MA' + slowPeriod, slowMA, slowStyle)

// 输出统计信息
const currentFast = fastMA[fastMA.length - 1]
const currentSlow = slowMA[slowMA.length - 1]
if (currentFast && currentSlow) {
    O.tools('MA差值', [(currentFast - currentSlow)], {color: '#FFB300'})
}
```

#### 高级示例 - 多数据输出
```javascript
//@name=MACD完整输出
//@position=vice
//@version=1

// 参数定义
fastPeriod = I.int(12, '快线周期')
slowPeriod = I.int(26, '慢线周期')
signalPeriod = I.int(9, '信号周期')

// 计算MACD
macdResult = F.macd(dataList, fastPeriod, slowPeriod, signalPeriod)
difData = F.attr(macdResult, 'dif')
deaData = F.attr(macdResult, 'dea')
macdData = F.attr(macdResult, 'macd')

// 样式定义
difStyle = S.line('#FF9900', 1, 'solid', title='DIF')
deaStyle = S.line('#0066CC', 1, 'solid', title='DEA')
macdStyle = S.bar('#666666', 'fill', title='MACD')

// 绘制
D.line(difData, difStyle)
D.line(deaData, deaStyle)
D.bar(macdData, 0, macdStyle)

// 设置副图
setMax(Math.max(...difData.filter(v => v !== null)))
setMin(Math.min(...macdData.filter(v => v !== null)))
setPrecision(4)

// 工具面板输出
O.tools('DIF(' + fastPeriod + ',' + slowPeriod + ')', difData, difStyle)
O.tools('DEA(' + signalPeriod + ')', deaData, deaStyle)
O.tools('MACD', macdData, macdStyle)

// 输出当前值
const currentDif = difData[difData.length - 1]
const currentDea = deaData[deaData.length - 1]
if (currentDif !== null && currentDea !== null) {
    O.tools('DIF-DEA差值', [currentDif - currentDea], {color: '#999999'})
}
```

### O.print() - 调试信息输出

输出调试信息到控制台，用于开发和调试。

#### 语法格式
```javascript
O.print(message, level?)
```

#### 参数详解
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `message` | string/any | ✅ | 输出内容 |
| `level` | string | ❌ | 日志级别：'info', 'warn', 'error' |

#### 基础示例
```javascript
//@name=调试输出示例
//@position=main
//@version=1

// 参数验证
period = I.int(20, '周期', 1, 200)
O.print('MA周期设置为: ' + period)

// 数据验证
if (dataList.length > 0) {
    O.print('K线数据长度: ' + dataList.length)
    O.print('最新收盘价: ' + dataList[dataList.length-1].close)
} else {
    O.print('警告: 没有K线数据', 'warn')
}

// 计算过程调试
ma = F.ma(dataList, period, 'close')
const validCount = ma.filter(v => v !== null).length
O.print('MA有效数据点: ' + validCount + '/' + ma.length)

// 错误检测
if (validCount === 0) {
    O.print('错误: MA计算结果全为null', 'error')
}

// 绘制
maStyle = S.line('#FF6600', 2, 'solid')
D.line(ma, maStyle)

// 输出
setPrecision('price')
O.tools('MA' + period, ma, maStyle)
```

#### 条件性调试输出
```javascript
// 开关控制调试输出
debugMode = I.bool(false, '调试模式')

// 只在调试模式下输出
if (debugMode) {
    O.print('=== 调试信息 ===')
    O.print('计算开始时间: ' + new Date().toLocaleTimeString())
    
    dataList.forEach((kline, index) => {
        if (index < 5) {  // 只输出前5根K线的信息
            O.print(`K线${index}: O=${kline.open}, H=${kline.high}, L=${kline.low}, C=${kline.close}`)
        }
    })
}
```

### O.log() - 日志记录输出

将信息记录到日志文件，用于长期监控和分析。

#### 语法格式
```javascript
O.log(message, category?)
```

#### 参数详解
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `message` | string | ✅ | 日志内容 |
| `category` | string | ❌ | 日志分类 |

#### 示例
```javascript
//@name=交易信号记录
//@position=main
//@version=1

// 计算双均线
fastMA = F.ma(dataList, 5, 'close')
slowMA = F.ma(dataList, 20, 'close')

// 信号检测
buySignals = F.throughUp(fastMA, slowMA)
sellSignals = F.throughDown(fastMA, slowMA)

// 记录信号到日志
buySignals.forEach((signal, index) => {
    if (signal !== null) {
        const timestamp = dataList[index]?.timestamp || Date.now()
        const price = dataList[index]?.close || 0
        O.log(`买入信号 - 时间: ${new Date(timestamp).toLocaleString()}, 价格: ${price}`, 'signals')
    }
})

sellSignals.forEach((signal, index) => {
    if (signal !== null) {
        const timestamp = dataList[index]?.timestamp || Date.now()
        const price = dataList[index]?.close || 0
        O.log(`卖出信号 - 时间: ${new Date(timestamp).toLocaleString()}, 价格: ${price}`, 'signals')
    }
})

// 记录统计信息
const buyCount = buySignals.filter(s => s !== null).length
const sellCount = sellSignals.filter(s => s !== null).length
O.log(`信号统计 - 买入: ${buyCount}, 卖出: ${sellCount}`, 'statistics')
```

### O.notify() - 通知消息输出

发送通知消息到用户界面，用于重要信息提醒。

#### 语法格式
```javascript
O.notify(message, type?, duration?)
```

#### 参数详解
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `message` | string | ✅ | 通知内容 |
| `type` | string | ❌ | 通知类型：'info', 'success', 'warning', 'error' |
| `duration` | number | ❌ | 显示时长（毫秒），默认3000 |

#### 示例
```javascript
//@name=价格突破提醒
//@position=main
//@version=1

// 参数定义
alertEnabled = I.bool(true, '启用提醒')
priceThreshold = I.float(50000, '价格阈值')

// 获取当前价格
currentPrice = dataList[dataList.length - 1]?.close

if (currentPrice && alertEnabled) {
    // 价格突破提醒
    if (currentPrice > priceThreshold) {
        O.notify(`价格突破阈值！当前价格: ${currentPrice.toFixed(2)}`, 'warning', 5000)
    }
    
    // 计算涨跌幅
    if (dataList.length >= 2) {
        const prevPrice = dataList[dataList.length - 2].close
        const changePercent = ((currentPrice - prevPrice) / prevPrice * 100).toFixed(2)
        
        if (Math.abs(changePercent) > 5) {
            const type = changePercent > 0 ? 'success' : 'error'
            O.notify(`价格大幅变动: ${changePercent}%`, type)
        }
    }
}
```

### O.export() - 数据导出输出

将计算结果导出到文件，用于外部分析或备份。

#### 语法格式
```javascript
O.export(data, filename?, format?)
```

#### 参数详解
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `data` | array/object | ✅ | 导出数据 |
| `filename` | string | ❌ | 文件名 |
| `format` | string | ❌ | 导出格式：'csv', 'json' |

#### 示例
```javascript
//@name=数据导出示例
//@position=main
//@version=1

// 计算多个指标
ma5 = F.ma(dataList, 5, 'close')
ma20 = F.ma(dataList, 20, 'close')
rsi = F.rsi(dataList, 14)

// 组织导出数据
exportData = dataList.map((kline, index) => ({
    timestamp: kline.timestamp,
    date: new Date(kline.timestamp).toISOString().split('T')[0],
    open: kline.open,
    high: kline.high,
    low: kline.low,
    close: kline.close,
    volume: kline.volume,
    ma5: ma5[index],
    ma20: ma20[index],
    rsi: rsi[index]
}))

// 导出到CSV文件
O.export(exportData, `${chartSymbol}_${chartPeriod}_analysis`, 'csv')

// 也可以导出JSON格式
const summary = {
    symbol: chartSymbol,
    period: chartPeriod,
    dataPoints: dataList.length,
    analysis: {
        currentPrice: dataList[dataList.length-1]?.close,
        ma5Current: ma5[ma5.length-1],
        ma20Current: ma20[ma20.length-1],
        rsiCurrent: rsi[rsi.length-1]
    }
}

O.export(summary, `${chartSymbol}_summary`, 'json')
```

## 🎯 输出最佳实践

### 1. 工具面板输出规范
```javascript
// ✅ 推荐：清晰的命名规范
O.tools('MA5', ma5, ma5Style)
O.tools('MA20', ma20, ma20Style)
O.tools('RSI(14)', rsi, rsiStyle)

// ✅ 推荐：带参数的动态命名
O.tools(`MA${period}`, ma, maStyle)
O.tools(`RSI(${rsiPeriod})`, rsi, rsiStyle)

// ❌ 避免：模糊的命名
O.tools('line1', ma5, ma5Style)
O.tools('data', rsi, rsiStyle)
```

### 2. 调试输出管理
```javascript
// ✅ 推荐：使用开关控制调试输出
debugMode = I.bool(false, '调试模式')

function debugPrint(message) {
    if (debugMode) {
        O.print(message)
    }
}

debugPrint('开始计算MA')
ma = F.ma(dataList, 20, 'close')
debugPrint('MA计算完成')
```

### 3. 条件性输出
```javascript
// ✅ 推荐：根据条件决定输出内容
showDetails = I.bool(false, '显示详细信息')

// 基础输出
O.tools('MA20', ma20, ma20Style)

// 详细信息（可选）
if (showDetails) {
    O.tools('MA20上升趋势', trendUp, trendStyle)
    O.tools('MA20下降趋势', trendDown, trendStyle)
    O.tools('价格与MA20差值', priceDiff, diffStyle)
}
```

### 4. 性能优化
```javascript
// ✅ 推荐：避免重复计算输出数据
ma = F.ma(dataList, 20, 'close')
currentMA = ma[ma.length - 1]

// 一次计算，多处使用
O.tools('MA20', ma, maStyle)
if (currentMA !== null) {
    O.print('当前MA20值: ' + currentMA.toFixed(2))
}

// ❌ 避免：重复计算
O.tools('MA20', F.ma(dataList, 20, 'close'), maStyle)  // 第一次计算
O.print('MA20: ' + F.ma(dataList, 20, 'close')[dataList.length-1])  // 重复计算
```

## 🚨 常见错误和解决方案

### 错误1：工具面板输出样式不匹配
```javascript
// ❌ 错误：样式不一致
D.line(ma, S.line('#FF0000', 2, 'solid'))
O.tools('MA', ma, S.line('#0000FF', 1, 'dashed'))  // 颜色和样式不一致

// ✅ 正确：使用相同样式
maStyle = S.line('#FF0000', 2, 'solid', title='MA线')
D.line(ma, maStyle)
O.tools('MA', ma, maStyle)  // 样式一致
```

### 错误2：输出数据格式错误
```javascript
// ❌ 错误：输出单个数值而非数组
currentValue = ma[ma.length - 1]
O.tools('当前MA', currentValue)  // 错误！应该是数组

// ✅ 正确：输出数组格式
O.tools('当前MA', [currentValue])  // 正确！
```

### 错误3：过量调试输出影响性能
```javascript
// ❌ 错误：无条件大量输出
dataList.forEach((kline, index) => {
    O.print(`处理K线 ${index}: ${kline.close}`)  // 可能输出数千条
})

// ✅ 正确：限制输出数量
dataList.forEach((kline, index) => {
    if (index < 10) {  // 只输出前10条
        O.print(`处理K线 ${index}: ${kline.close}`)
    }
})
```

## 🔗 相关内容

- **数据来源**: [F方法详解](05-计算函数方法(F方法).md) - 计算输出数据的方法
- **样式定义**: [S方法详解](04-样式设置方法(S方法).md) - 输出样式的定义方法
- **绘图配合**: [D方法详解](06-绘图输出方法(D方法).md) - 输出与绘图的配合使用
- **实际案例**: [脚本案例库](09-完整脚本案例库.md) - O方法在实际指标中的应用
- **错误处理**: [错误处理指南](10-错误处理和调试指南.md) - O方法常见问题解决

---
**提示**: O方法是用户交互的重要桥梁，共5个输出方法覆盖工具面板、调试、日志、通知、导出等各种输出需求。合理使用O方法能提供良好的用户体验和开发调试支持。