# D方法 - 绘图输出

## 📋 D方法概述

**D方法（Draw Method）**用于在图表上绘制各种图形元素，是GainLab Script的可视化核心，提供15个专业绘图方法，支持K线坐标系和屏幕坐标系两套绘图体系。

### 🎯 核心特点
- 🎨 **双坐标系统** - 支持K线坐标和屏幕坐标两套体系
- 📊 **图形丰富** - 线条、柱状图、区域、图形、文本等15种绘图方式
- 🎭 **动态样式** - 支持样式回调函数实现动态效果
- 🔄 **数据驱动** - 直接使用F方法计算结果进行绘图

### ⚠️ 核心约束
- **✅ 必须配合S方法** - D方法需要S方法定义的样式对象
- **✅ 支持null值** - 自动处理null值，产生断点或跳过
- **✅ 数据长度匹配** - 绘图数据长度应与dataList匹配
- **✅ 坐标系选择** - K线坐标用于价格，屏幕坐标用于固定位置

## 🗂️ D方法完整分类

### 📊 K线坐标系绘图（10个方法）
| 方法 | 功能 | 适用数据 | 使用频率 |
|------|------|---------|---------|
| [D.line()](#D.line) | 绘制线条 | 数值数组 | 🔥 极高 |
| [D.bar()](#D.bar) | 绘制柱状图 | 数值数组 | 🔥 极高 |
| [D.area()](#D.area) | 绘制区域填充 | 两个数值数组 | 📊 高 |
| [D.candle()](#D.candle) | 绘制K线 | OHLC数据 | 📊 高 |
| [D.shape()](#D.shape) | 绘制图形标记 | 布尔/对象数组 | 📊 高 |
| [D.label()](#D.label) | 绘制文本标签 | 字符串数组 | 📊 高 |
| [D.hline()](#D.hline) | 绘制水平线 | 固定数值 | 📝 中等 |
| [D.vline()](#D.vline) | 绘制垂直线 | 时间戳/索引 | 📝 中等 |
| [D.rect()](#D.rect) | 绘制矩形 | 坐标数组 | 📝 中等 |
| [D.poly()](#D.poly) | 绘制多边形 | 坐标点数组 | 📝 低 |

### 🖥️ 屏幕坐标系绘图（5个方法）
| 方法 | 功能 | 坐标系 | 使用频率 |
|------|------|-------|---------|
| [D.slabel()](#D.slabel) | 屏幕文本标签 | 像素坐标 | 📝 中等 |
| [D.sarea()](#D.sarea) | 屏幕区域填充 | 像素坐标 | 📝 低 |
| [D.srect()](#D.srect) | 屏幕矩形 | 像素坐标 | 📝 低 |
| [D.scircle()](#D.scircle) | 屏幕圆形 | 像素坐标 | 📝 低 |
| [D.sshape()](#D.sshape) | 屏幕图形 | 像素坐标 | 📝 低 |

## 📊 核心绘图方法

### D.line() - 线条绘制

绘制线条图，是使用频率最高的D方法。

#### 语法格式
```javascript
D.line(data, style, options?)
```

#### 参数详解
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `data` | array | ✅ | 数值数组 |
| `style` | object/function | ✅ | 样式对象或回调函数 |
| `options` | object | ❌ | 绘图选项 |

#### 基础示例
```javascript
//@name=双均线系统
//@position=main
//@version=1

// 参数定义
fastPeriod = I.int(5, '快线周期', 1, 50)
slowPeriod = I.int(20, '慢线周期', 1, 200)

// 样式定义
fastStyle = S.line('#FF0000', 2, 'solid', title='快线')
slowStyle = S.line('#0000FF', 2, 'solid', title='慢线')

// 计算均线
fastMA = F.ma(dataList, fastPeriod, 'close')
slowMA = F.ma(dataList, slowPeriod, 'close')

// 绘制线条
D.line(fastMA, fastStyle)
D.line(slowMA, slowStyle)

// 输出设置
setPrecision('price')
O.tools('快线MA' + fastPeriod, fastMA, fastStyle)
O.tools('慢线MA' + slowPeriod, slowMA, slowStyle)
```

#### 高级示例 - 动态样式回调
```javascript
//@name=趋势变色均线
//@position=main
//@version=1

// 参数和计算
period = I.int(20, '均线周期')
ma = F.ma(dataList, period, 'close')

// 样式定义
upStyle = S.line('#00FF00', 2, 'solid')
downStyle = S.line('#FF0000', 2, 'solid')
neutralStyle = S.line('#FFFF00', 2, 'solid')

// 动态样式绘制
D.line(ma, ({value, prev, index}) => {
    if (value === null || prev === null) return neutralStyle
    
    if (value > prev) {
        return upStyle    // 上涨用绿色
    } else if (value < prev) {
        return downStyle  // 下跌用红色
    } else {
        return neutralStyle // 横盘用黄色
    }
})

// 输出
setPrecision('price')
O.tools('趋势MA', ma, upStyle)
```

### D.bar() - 柱状图绘制

绘制柱状图，常用于成交量、MACD等指标。

#### 语法格式
```javascript
D.bar(data, baseline?, style, options?)
```

#### 参数详解
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `data` | array | ✅ | 数值数组 |
| `baseline` | number/array | ❌ | 基准线，默认0 |
| `style` | object/function | ✅ | 样式对象或回调函数 |
| `options` | object | ❌ | 绘图选项 |

#### 完整示例 - MACD柱状图
```javascript
//@name=MACD专业版
//@position=vice
//@version=1

// 参数定义
fastPeriod = I.int(12, '快线周期', 1, 50)
slowPeriod = I.int(26, '慢线周期', 1, 100)
signalPeriod = I.int(9, 'DEA周期', 1, 50)

// 样式定义
difStyle = S.line('#FF9900', 1, 'solid', title='DIF线')
deaStyle = S.line('#0066CC', 1, 'solid', title='DEA线')
zeroStyle = S.line('#999999', 1, 'solid', title='零轴线')

// MACD柱状图样式
macdBullUp = S.bar('#00C851', 'stroke', title='多头增强')
macdBullDown = S.bar('#00C851', 'fill', title='多头减弱')
macdBearUp = S.bar('#FF4444', 'stroke', title='空头减弱')  
macdBearDown = S.bar('#FF4444', 'fill', title='空头增强')

// 计算MACD
macdResult = F.macd(dataList, fastPeriod, slowPeriod, signalPeriod)
difData = F.attr(macdResult, 'dif')
deaData = F.attr(macdResult, 'dea')
macdData = F.attr(macdResult, 'macd')

// 绘制零轴线
D.hline(0, zeroStyle)

// 动态柱状图绘制
D.bar(macdData, 0, ({value, prev}) => {
    if (value >= 0) {
        // 多头区域
        return value >= prev ? macdBullUp : macdBullDown
    } else {
        // 空头区域  
        return value >= prev ? macdBearUp : macdBearDown
    }
})

// 绘制DIF和DEA线
D.line(difData, difStyle)
D.line(deaData, deaStyle)

// 副图设置
setPrecision(4)
O.tools('DIF', difData, difStyle)
O.tools('DEA', deaData, deaStyle)
O.tools('MACD', macdData, {color: '#666666'})
```

### D.area() - 区域填充

绘制两条线之间的填充区域。

#### 语法格式
```javascript
D.area(upperData, lowerData, style, options?)
```

#### 参数详解
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `upperData` | array | ✅ | 上边界数据 |
| `lowerData` | array | ✅ | 下边界数据 |
| `style` | object | ✅ | 区域样式 |
| `options` | object | ❌ | 绘图选项 |

#### 完整示例 - 布林带通道
```javascript
//@name=布林带通道
//@position=main
//@version=1

// 参数定义
bollPeriod = I.int(20, '布林周期', 5, 100)
bollMultiplier = I.float(2.0, '标准差倍数', 0.5, 5.0, 0.1)
showFill = I.bool(true, '显示填充')
fillOpacity = I.float(0.1, '填充透明度', 0.05, 0.5, 0.05)

// 样式定义
midStyle = S.line('#FFB300', 2, 'solid', title='中轨')
upperStyle = S.line('#E91E63', 1, 'solid', title='上轨')
lowerStyle = S.line('#E91E63', 1, 'solid', title='下轨')
fillStyle = S.area(`rgba(233, 30, 99, ${fillOpacity})`, showFill, title='通道填充')

// 计算布林带
bollResult = F.boll(dataList, bollPeriod, bollMultiplier)
midData = F.attr(bollResult, 'mid')
upperData = F.attr(bollResult, 'ub')
lowerData = F.attr(bollResult, 'lb')

// 绘制填充区域（如果启用）
if (showFill) {
    D.area(upperData, lowerData, fillStyle)
}

// 绘制布林带线条
D.line(upperData, upperStyle)
D.line(midData, midStyle)
D.line(lowerData, lowerStyle)

// 突破信号检测
closeData = F.attr(dataList, 'close')
upperBreak = F.throughUp(closeData, upperData)
lowerBreak = F.throughDown(closeData, lowerData)

// 输出设置
setPrecision('price')
O.tools('BOLL上轨', upperData, upperStyle)
O.tools('BOLL中轨', midData, midStyle)
O.tools('BOLL下轨', lowerData, lowerStyle)
```

### D.shape() - 图形标记

在图表上绘制各种图形标记，用于标识信号或重要点位。

#### 语法格式
```javascript
D.shape(data, style, options?)
```

#### 参数详解
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `data` | array | ✅ | 布尔数组或对象数组 |
| `style` | object/function | ✅ | 图形样式 |
| `options` | object | ❌ | 绘图选项 |

#### 完整示例 - 金叉死叉信号
```javascript
//@name=双均线交叉信号
//@position=main
//@version=1

// 参数定义
fastPeriod = I.int(5, '快线周期', 1, 50)
slowPeriod = I.int(20, '慢线周期', 5, 200)
showSignals = I.bool(true, '显示信号')
signalFilter = I.bool(false, '启用信号过滤')

// 样式定义
fastStyle = S.line('#FF0000', 2, 'solid', title='快线')
slowStyle = S.line('#0000FF', 2, 'solid', title='慢线')

// 信号样式
buySignalStyle = S.shape('arrowUp', '#4CAF50', 12, 'lowDown', 'fill', title='买入信号')
sellSignalStyle = S.shape('arrowDown', '#F44336', 12, 'highUp', 'fill', title='卖出信号')

// 计算移动平均
fastMA = F.ma(dataList, fastPeriod, 'close')
slowMA = F.ma(dataList, slowPeriod, 'close')

// 绘制均线
D.line(fastMA, fastStyle)
D.line(slowMA, slowStyle)

// 信号计算
buySignals = F.throughUp(fastMA, slowMA)     // 金叉信号
sellSignals = F.throughDown(fastMA, slowMA)  // 死叉信号

// 绘制信号（如果启用）
if (showSignals) {
    D.shape(buySignals, buySignalStyle)
    D.shape(sellSignals, sellSignalStyle)
}

// 信号统计
if (buySignals && sellSignals) {
    const buyCount = buySignals.filter(s => s !== null).length
    const sellCount = sellSignals.filter(s => s !== null).length
    O.print(`金叉信号数量: ${buyCount}`)
    O.print(`死叉信号数量: ${sellCount}`)
}

// 输出设置
setPrecision('price')
O.tools('快线MA' + fastPeriod, fastMA, fastStyle)
O.tools('慢线MA' + slowPeriod, slowMA, slowStyle)
```

### D.label() - 文本标签

在图表上绘制文本标签，显示价格、信息等。

#### 语法格式
```javascript
D.label(data, style, backgroundStyle?, options?)
```

#### 参数详解
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `data` | array | ✅ | 字符串数组或对象数组 |
| `style` | object | ✅ | 文本样式 |
| `backgroundStyle` | object | ❌ | 背景样式 |
| `options` | object | ❌ | 绘图选项 |

#### 示例
```javascript
//@name=价格标签系统
//@position=main
//@version=1

// 参数定义
showPriceLabels = I.bool(true, '显示价格标签')
labelFrequency = I.int(10, '标签频率', 1, 50)

// 样式定义
labelStyle = S.label('#FFFFFF', 12, 'center', 'value', title='价格标签')
labelBg = S.labelbg('rgba(0, 0, 0, 0.7)', 'fill', title='标签背景')

// 生成标签数据
priceLabels = dataList.map((kline, index) => {
    if (index % labelFrequency === 0 && showPriceLabels) {
        return `$${kline.close.toFixed(2)}`
    }
    return null
})

// 绘制标签
if (showPriceLabels) {
    D.label(priceLabels, labelStyle, labelBg)
}
```

## 🖥️ 屏幕坐标系绘图

### D.slabel() - 屏幕文本标签

在屏幕固定位置绘制文本标签。

#### 语法格式
```javascript
D.slabel(x, y, text, style, backgroundStyle?)
```

#### 参数详解
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `x` | number | ✅ | X坐标（像素） |
| `y` | number | ✅ | Y坐标（像素） |
| `text` | string | ✅ | 显示文字 |
| `style` | object | ✅ | 文本样式 |
| `backgroundStyle` | object | ❌ | 背景样式 |

#### 示例 - 信息面板
```javascript
//@name=交易信息面板
//@position=main
//@version=1

// 样式定义
panelTextStyle = S.slabel('#FFFFFF', 14, 'left', 'bold')
panelBgStyle = S.labelbg('rgba(0, 0, 0, 0.8)', 'fill')

// 获取当前数据
currentKline = dataList[dataList.length - 1]
if (currentKline) {
    const info = [
        `交易对: ${chartSymbol}`,
        `周期: ${chartPeriod}`,
        `开盘: ${currentKline.open.toFixed(2)}`,
        `最高: ${currentKline.high.toFixed(2)}`,
        `最低: ${currentKline.low.toFixed(2)}`,
        `收盘: ${currentKline.close.toFixed(2)}`,
        `成交量: ${currentKline.volume.toFixed(0)}`
    ]
    
    // 绘制信息面板
    info.forEach((text, index) => {
        D.slabel(20, 20 + index * 20, text, panelTextStyle, panelBgStyle)
    })
}
```

## 🎨 高级绘图技巧

### 1. 条件性绘图
```javascript
// 根据条件决定是否绘制
showMA = I.bool(true, '显示MA线')
if (showMA) {
    D.line(ma, maStyle)
}

// 使用三元运算符
D.line(ma, showMA ? maStyle : {show: false})
```

### 2. 多时间框架支持
```javascript
//@name=多时间框架指标
//@position=main
//@version=1

// 参数定义
timeframe = I.select('1h', ['15m', '1h', '4h', '1d'], '时间框架')

// 根据时间框架调整参数
let period
switch(timeframe) {
    case '15m': period = 20; break
    case '1h': period = 14; break
    case '4h': period = 10; break
    case '1d': period = 7; break
    default: period = 14
}

// 计算和绘制
ma = F.ma(dataList, period, 'close')
maStyle = S.line('#FF6600', 2, 'solid', title=`MA${period}(${timeframe})`)
D.line(ma, maStyle)
```

### 3. 动态透明度效果
```javascript
// 基于距离的透明度变化
D.line(ma, ({value, index}) => {
    const currentPrice = dataList[index]?.close || 0
    const distance = Math.abs(value - currentPrice)
    const maxDistance = currentPrice * 0.1 // 10%的距离
    const opacity = Math.max(0.1, 1 - (distance / maxDistance))
    
    return {
        color: `rgba(255, 102, 0, ${opacity})`,
        size: 2,
        style: 'solid'
    }
})
```

## 🚨 常见错误和解决方案

### 错误1：数据长度不匹配
```javascript
// ❌ 错误：数据长度不一致
shortData = [1, 2, 3]  // 只有3个元素
D.line(shortData, maStyle)  // 与dataList长度不匹配

// ✅ 正确：确保数据长度匹配
fillData = new Array(dataList.length).fill(null)
fillData[fillData.length-1] = currentValue
D.line(fillData, maStyle)
```

### 错误2：样式对象未定义
```javascript
// ❌ 错误：直接使用未定义的样式
D.line(ma, undefined)  // 报错！

// ✅ 正确：确保样式对象存在
maStyle = S.line('#FF6600', 2, 'solid')
D.line(ma, maStyle)
```

### 错误3：回调函数没有返回值
```javascript
// ❌ 错误：回调函数未返回样式
D.line(data, ({value}) => {
    if (value > 0) {
        console.log("positive")  // 没有返回！
    }
})

// ✅ 正确：必须返回样式对象
D.line(data, ({value}) => {
    return value > 0 ? upStyle : downStyle  // 正确返回
})
```

## 💡 最佳实践建议

### 1. 绘图顺序优化
```javascript
// ✅ 推荐：先绘制背景，再绘制前景
D.area(upperBand, lowerBand, fillStyle)  // 先绘制填充区域
D.line(upperBand, upperStyle)            // 再绘制边界线
D.line(lowerBand, lowerStyle)
D.shape(signals, signalStyle)            // 最后绘制信号
```

### 2. 性能优化
```javascript
// ✅ 推荐：避免重复计算
ma = F.ma(dataList, 20, 'close')  // 只计算一次
D.line(ma, maStyle1)               // 复用计算结果
D.line(ma, maStyle2)

// ❌ 避免：重复计算
D.line(F.ma(dataList, 20, 'close'), maStyle1)  // 重复计算
D.line(F.ma(dataList, 20, 'close'), maStyle2)
```

### 3. 样式管理
```javascript
// ✅ 推荐：统一的样式管理
const COLORS = {
    UP: '#00C851',
    DOWN: '#FF4444',
    NEUTRAL: '#FFB300'
}

upStyle = S.line(COLORS.UP, 2, 'solid')
downStyle = S.line(COLORS.DOWN, 2, 'solid')
```

## 🔗 相关内容

- **样式配合**: [S方法详解](04-样式设置方法(S方法).md) - 学习样式定义
- **数据来源**: [F方法详解](05-计算函数方法(F方法).md) - 学习数据计算
- **参数控制**: [I方法详解](03-输入参数方法(I方法).md) - 用户可控的绘图参数
- **实际案例**: [脚本案例库](09-完整脚本案例库.md) - 查看D方法实际应用
- **错误处理**: [错误处理指南](10-错误处理和调试指南.md) - D方法常见问题解决

---
**提示**: D方法是视觉化的核心，共15个绘图方法支持K线坐标和屏幕坐标两套体系。合理使用D方法能创造出专业美观的技术指标界面。